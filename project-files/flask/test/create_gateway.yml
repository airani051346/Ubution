---
- name: Create single gateway object on management server
  hosts: localhost
  gather_facts: false

  vars:
    gw_name: "{{ inventory_hostname | default('gateway1') }}"
    ansible_host: "{{ ansible_host | default('192.168.1.1') }}"
    gaia_mode: "{{ gaia_mode | default('spark') }}"   # spark or full
    mgmt_server: "127.0.0.1"     # Adjust to your SMS/MDS
    mgmt_user: "api-user"        # Change to your API user
    mgmt_password: "supersecret" # Use vault in prod
    session_file: "/tmp/ansible_mgmt_session.json"

  tasks:
    - name: Login to management server
      command: >
        mgmt_cli login
        -m {{ mgmt_server }}
        -u {{ mgmt_user }}
        -p {{ mgmt_password }}
        --format json
      register: login_result
      changed_when: false

    - name: Save session file
      copy:
        content: "{{ login_result.stdout }}"
        dest: "{{ session_file }}"

    - name: Create Gaia Embedded (Spark) gateway object
      command: >
        mgmt_cli add simple-gateway
        name "{{ gw_name }}"
        ipv4-address "{{ ansible_host }}"
        os-name GaiaEmbedded
        --session-file {{ session_file }}
      when: gaia_mode == "spark"

    - name: Create Full Gaia gateway object
      command: >
        mgmt_cli add simple-gateway
        name "{{ gw_name }}"
        ipv4-address "{{ ansible_host }}"
        os-name Gaia
        --session-file {{ session_file }}
      when: gaia_mode == "full"

    - name: Publish changes
      command: >
        mgmt_cli publish
        --session-file {{ session_file }}

    - name: Logout from management server
      command: >
        mgmt_cli logout
        --session-file {{ session_file }}
      always_run: true
