---
- name: Create cluster object on management server
  hosts: localhost
  gather_facts: false

  vars:
    cluster_name: "{{ cluster_name | default('Cluster1') }}"
    member1: "{{ member1 | default('cl1-gw1') }}"
    member1_type: "{{ member1_type | default('spark') }}"
    member2: "{{ member2 | default('cl1-gw2') }}"
    member2_type: "{{ member2_type | default('spark') }}"
    mgmt_server: "127.0.0.1"     # Adjust to your SMS/MDS
    mgmt_user: "api-user"        # Change to your API user
    mgmt_password: "supersecret" # Use vault in prod
    session_file: "/tmp/ansible_mgmt_session.json"

  tasks:
    - name: Login to management server
      command: >
        mgmt_cli login
        -m {{ mgmt_server }}
        -u {{ mgmt_user }}
        -p {{ mgmt_password }}
        --format json
      register: login_result
      changed_when: false

    - name: Save session file
      copy:
        content: "{{ login_result.stdout }}"
        dest: "{{ session_file }}"

    - name: Create cluster object
      command: >
        mgmt_cli add cluster
        name "{{ cluster_name }}"
        cluster-mode cluster-xl
        ipv4-address "192.168.50.1"
        --session-file {{ session_file }}

    - name: Add member1 (Spark)
      command: >
        mgmt_cli add simple-gateway
        name "{{ member1 }}"
        os-name GaiaEmbedded
        ipv4-address "192.168.50.11"
        --session-file {{ session_file }}
      when: member1_type == "spark"

    - name: Add member1 (Full Gaia)
      command: >
        mgmt_cli add simple-gateway
        name "{{ member1 }}"
        os-name Gaia
        ipv4-address "192.168.50.11"
        --session-file {{ session_file }}
      when: member1_type == "full"

    - name: Add member2 (Spark)
      command: >
        mgmt_cli add simple-gateway
        name "{{ member2 }}"
        os-name GaiaEmbedded
        ipv4-address "192.168.50.12"
        --session-file {{ session_file }}
      when: member2_type == "spark"

    - name: Add member2 (Full Gaia)
      command: >
        mgmt_cli add simple-gateway
        name "{{ member2 }}"
        os-name Gaia
        ipv4-address "192.168.50.12"
        --session-file {{ session_file }}
      when: member2_type == "full"

    - name: Publish changes
      command: >
        mgmt_cli publish
        --session-file {{ session_file }}

    - name: Logout from management server
      command: >
        mgmt_cli logout
        --session-file {{ session_file }}
      always_run: true
